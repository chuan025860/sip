<!doctype html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
	<!-- TITLE OF SITE -->
	<title>SIP-建立訂單-2</title>
	<div th:replace="~{indexNavbar/navbar1}"></div>
</head>
<style>
	input[readonly] {
		background-color: transparent !important;
	}

	.form-label {
		font-size: 18px;
		margin-bottom: 5px;
	}

	#paymentMethod {
		width: 20%;

		padding: 8px;
		border-radius: 8px;
	}

	.Error {
		color: rgb(240, 60, 60);
	}
</style>

<body>

	<div th:replace="~{indexNavbar/navbar2}"></div>

	<!-- 插入空白行，背景顏色保持一致 -->
	<section style="background-color: #f9f9f9;">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="spacer" style="height: 20px;"></div>
				</div>
			</div>
		</div>
	</section>

	<!--travel-box start-->
	<section class="travel-box" style="background-color: #f9f9f9;">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="">
						<div id="desc-tabs" class="desc-tabs">
							<!-- Tab panes -->
							<div class="tab-content">
								<div role="tabpanel" class="tab-pane active fade in" id="booking">
									<div class="tab-para">
										<form id="insterOrder" method="post">
											<input type="hidden" th:name="${_csrf.parameterName}"
												th:value="${_csrf.token}" />
											<div class="mb-3">
												<label for="email" class="form-label">電子郵件：</label>
												<input type="email" class="form-control" id="email" name="email"
													style="width: 300px;" required>
											</div>
											<span class="Error" id="emailError"></span> <!-- 顯示錯誤訊息 -->
											<br>
											<div class="mb-3">
												<label for="lastName" class="form-label">姓氏：</label>
												<input type="text" class="form-control" id="lastName" name="lastName"
													style="width: 300px;" required>
											</div>
											<span class="Error" id="lastNameError"></span> <!-- 顯示錯誤訊息 -->
											<br>
											<div class="mb-3">
												<label for="firstName" class="form-label">名子：</label>
												<input type="text" class="form-control" id="firstName" name="firstName"
													style="width: 300px;" required>
											</div>
											<span class="Error" id="firstNameError"></span> <!-- 顯示錯誤訊息 -->
											<br>
											<div class="mb-3">
												<label for="tel" class="form-label">連絡電話：</label>
												<input type="number" class="form-control" id="tel" name="tel"
													style="width: 300px;" required>
											</div>
											<br>
											<div class="mb-3">
												<label for="check-in" class="form-label">入住日期：</label>
												<input type="hidden" class="form-control" id="check-in"
													name="checkinDay" th:value="${checkinDay}" readonly>
												<h4 th:text="${checkinDay}"></h4>

											</div>
											<br>
											<div class="mb-3">
												<label for="check-out" class="form-label">退房日期：</label>
												<input type="hidden" class="form-control" id="check-out"
													name="checkoutDay" th:value="${checkoutDay}" readonly>
												<h4 th:text="${checkoutDay}"></h4>

											</div>
											<br>
											<div class="mb-3">
												<input type="hidden" class="form-control" id="hotelName"
													name="hotelName" th:value="${hotelName}" readonly>
												<h4 th:text="${hotelName}"></h4>
											</div>
											<br>
											<th:block th:each="room:${selectedRooms}">
												<div class="mb-3">
													<h4
														th:text="${room.productName + '&nbsp;&nbsp;&nbsp;&nbsp;數量: ' + room.quantity+ '&nbsp;&nbsp;&nbsp;&nbsp;價錢: ' + room.orderItemPrice}">
													</h4>
												</div>
												<br>
											</th:block>

											<div class="mb-3">
												<input type="hidden" class="form-control" id="totalPeople"
													name="totalPeople" th:value="${totalPeople}" readonly>
												<h4 th:text="${totalPeople+'位成人'}"></h4>
											</div>
											<br>
											<div class="mb-3">
												<input type="hidden" class="form-control" id="totalPrice"
													name="totalPrice" th:value="${totalPrice}">
												<h4 th:text="'總金額&nbsp;&nbsp;&nbsp;TWD'+${totalPrice}"></h4>
											</div>
											<br>
											<div class="mb-3">
												<label for="paymentMethod" class="form-label">付款方式:</label>
												<select class="form-select" id="paymentMethod" name="paymentMethod">
													<option value="cash">現金付款</option>
													<option value="ECPay">綠界支付</option>
												</select>
											</div>
											<br>
											<!-- 其他表單項目根據需求添加 -->
											<button id="submit" type="submit" class="btn btn-primary">下一步送出訂單</button>
										</form>
									</div><!--/.tab-para-->
								</div><!--/.tab-pane-->
							</div><!--/.desc-tabs-->
						</div><!--/.single-travel-box-->
					</div><!--/.col-->
				</div><!--/.row-->
			</div><!--/.container-->

	</section><!--/.travel-box-->



	<!--galley start-->
	<section id="gallery" class="gallery">
		<div class="container">
			<div class="gallery-details">
				<div class="gallary-header text-center">
					<h2>
						top destination
					</h2>
				</div><!--/.gallery-header-->
				<div class="gallery-box">
					<div class="gallery-content">
						<div class="filtr-container">
							<div class="row">

								<div class="col-md-6">
									<div class="filtr-item">
										<img src="../assets/images/gallary/taipei.jpg" alt="portfolio image" />
										<div class="item-title">
											<a href="#">
												台北
											</a>
											<p><span>Taipei</span></p>
										</div><!-- /.item-title -->
									</div><!-- /.filtr-item -->
								</div><!-- /.col -->

								<div class="col-md-6">
									<div class="filtr-item">
										<img src="../assets/images/gallary/taichung.jpg" alt="portfolio image" />
										<div class="item-title">
											<a href="#">
												台中
											</a>
											<p><span>Taichung</span></p>
										</div> <!-- /.item-title-->
									</div><!-- /.filtr-item -->
								</div><!-- /.col -->

								<div class="col-md-4">
									<div class="filtr-item">
										<img src="../assets/images/gallary/tainan.jpg" alt="portfolio image" />
										<div class="item-title">
											<a href="#">
												台南
											</a>
											<p><span>Tainan</span></p>
										</div><!-- /.item-title -->
									</div><!-- /.filtr-item -->
								</div><!-- /.col -->

								<div class="col-md-4">
									<div class="filtr-item">
										<img src="../assets/images/gallary/taitung.jpg" alt="portfolio image" />
										<div class="item-title">
											<a href="#">
												台東
											</a>
											<p><span>taitung</span></p>
										</div> <!-- /.item-title-->
									</div><!-- /.filtr-item -->
								</div><!-- /.col -->

								<div class="col-md-4">
									<div class="filtr-item">
										<img src="../assets/images/gallary/hualien.jpg" alt="portfolio image" />
										<div class="item-title">
											<a href="#">
												花蓮
											</a>
											<p><span>hualien</span></p>
										</div> <!-- /.item-title-->
									</div><!-- /.filtr-item -->
								</div><!-- /.col -->

								<div class="col-md-8">
									<div class="filtr-item">
										<img src="../assets/images/gallary/yilan.jpg" alt="portfolio image" />
										<div class="item-title">
											<a href="#">
												宜蘭
											</a>
											<p><span>yilan</span></p>
										</div> <!-- /.item-title-->
									</div><!-- /.filtr-item -->
								</div><!-- /.col -->

							</div><!-- /.row -->
						</div><!-- /.filtr-container-->
					</div><!-- /.gallery-content -->
				</div><!--/.galley-box-->
			</div><!--/.gallery-details-->
		</div><!--/.container-->
	</section><!--/.gallery-->


	<div th:replace="~{indexNavbar/navbar3}"></div>
	<div th:replace="~{indexNavbar/navbar4}"></div>
	<script>
		$(document).ready(function () {
			$('#submit').click(function (event) {
				event.preventDefault();
				// 取得Form資料
				const formData = $('#insterOrder').serialize();
				const paymentMethod = $('#paymentMethod').val();  // 取得選擇的付款方式
				Swal.fire({
					title: "建立訂單中...",
					text: "請稍候",
					icon: "info",
					allowOutsideClick: false, // 禁止點擊背景關閉
					allowEscapeKey: false, // 禁止按下 ESC 鍵關閉
					allowEnterKey: false, // 禁止按下 Enter 鍵關閉
					showConfirmButton: false,
					willOpen: () => {
						Swal.showLoading(); // 顯示Loading
					}
				});
				// 檢查選擇的付款方式，如果是綠界支付則執行相應的處理
				if (paymentMethod === "ECPay") { // 發送 AJAX 請求到後端處理 ECPay 流程
					$.ajax({
						type: 'POST',
						url: '/sip/sipIndex/ECPay',  // 這裡是後端處理綠界支付的 URL
						data: formData,
						headers: {
							'X-CSRF-TOKEN': $('input[name=_csrf]').val()  // 如果需要 CSRF 保護，確保提供這個 token
						},
						success: function (response) {
							console.log(response); // 確保 response 返回的是支付表單的 HTML 字符串

							// 假設 response 返回的是表單的 HTML 字符串
							var formHtml = response;

							// 創建一個隱藏的 div 並將返回的表單插入
							var formContainer = $('<div></div>').html(formHtml);
							$('body').append(formContainer); // 把表單加入到頁面中

							// 提交表單到綠界支付頁面
							formContainer.find('form').submit();
						},
						error: function (error) {
							console.error('AJAX error:', error);
							Swal.fire({
								icon: 'error',
								title: '錯誤',
								text: '處理訂單時發生錯誤，請稍後再試。',
							});
						}
					});
				} else {
					// 現金付款
					$.ajax({
						type: 'POST',
						url: '/sip/sipIndex/booking3',
						data: formData,
						headers: {
							'X-CSRF-TOKEN': $('input[name=_csrf]').val()
						},
						success: function (response) {
							console.log(response)
							if (response === 'Error') {
								Swal.fire({
									icon: "error",
									title: "Oops...",
									text: "有一些錯誤",
								});
							} else if (response === 'quantityError') {
								Swal.fire({
									icon: "error",
									title: "Oops...",
									text: "商品數量不足",
								});
							} else {
								window.location.href = "/sip/sipIndex/orderDetail?orderID=" + response;
							}

						},
						error: function (error) {
							console.error('AJAX error:', error);
							Swal.fire({
								icon: 'error',
								title: '錯誤',
								text: '處理訂單時發生錯誤，請稍後再試。',
							});
						}
					});
				}


			});
		})

		var emailInput = document.getElementById('email');
		var emailError = document.getElementById('emailError');
		var lastNameInput = document.getElementById('lastName');
		var lastNameError = document.getElementById('lastNameError');
		var firstNameInput = document.getElementById('firstName');
		var firstNameError = document.getElementById('firstNameError');


		emailInput.addEventListener('input', validateEmail);
		lastNameInput.addEventListener('input', validateLastName);
		firstNameInput.addEventListener('input', validateFirstName);
		// 正規表示式 中英文
		var Regex = /^[a-zA-Z0-9\s\u4e00-\u9fa5#.,-]+$/;
		// 正規表示式 email
		var RegexEmail = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
		// 定義敏感詞彙
		var sensitiveWords = ["fuck", "Fuck"];

		function validateContentEmail(text) {
			if (text.trim() === '') {
				return "required"; //限制 用required控制
			}
			if (!RegexEmail.test(text)) {
				return "invalid"; //格式錯誤
			}
			return "valid"; // all checks
		}

		function validateContent(text) {
			if (text.trim() === '') {
				return "required"; //限制 用required控制
			}
			if (!Regex.test(text)) {
				return "invalid"; //是否包含敏感詞彙
			}
			for (var i = 0; i < sensitiveWords.length; i++) {
				if (text.toLowerCase().includes(sensitiveWords[i].toLowerCase())) {
					return "sensitive"; //是否包含敏感詞彙
				}
			}
			return "valid"; // all checks
		}

		function validateEmail() {
			var email = emailInput.value;
			var validationResult = validateContentEmail(email);
			console.log('啟動');
			if (validationResult === "required") {
				emailError.style.display = 'none';
				emailError.textContent = '';
				return false;
			} else if (validationResult === "invalid") {
				emailError.style.display = 'block';
				emailError.textContent = '格式錯誤';
				return false; //輸入錯誤
			}
			emailError.style.display = 'none';
			emailError.textContent = '';
			return true;
		}
		function validateLastName() {
			var lastName = lastNameInput.value;
			var validationResult = validateContent(lastName);
			console.log('啟動');
			if (validationResult === "required") {
				lastNameError.style.display = 'none';
				lastNameError.textContent = '';
				return false;
			} else if (validationResult === "invalid") {
				lastNameError.style.display = 'block';
				lastNameError.textContent = '含敏感詞彙';
				return false; //輸入錯誤
			} else if (validationResult === "sensitive") {
				lastNameError.style.display = 'block';
				lastNameError.textContent = '含敏感詞彙';
				return false;
			}
			lastNameError.style.display = 'none';
			lastNameError.textContent = '';
			return true;
		}
		function validateFirstName() {
			var firstName = firstNameInput.value;
			var validationResult = validateContent(firstName);
			console.log('啟動');
			if (validationResult === "required") {
				firstNameError.style.display = 'none';
				firstNameError.textContent = '';
				return false;
			} else if (validationResult === "invalid") {
				firstNameError.style.display = 'block';
				firstNameError.textContent = '含敏感詞彙';
				return false; //輸入錯誤
			} else if (validationResult === "sensitive") {
				firstNameError.style.display = 'block';
				firstNameError.textContent = '含敏感詞彙';
				return false;
			}
			firstNameError.style.display = 'none';
			firstNameError.textContent = '';
			return true;
		}

		// 驗證數據 送出數據
		function validateAndSubmit() {
			var isLastName = validateLastName();
			var isFirstName = validateFirstName();
			var isEmail = validateEmail();
			if (isEmail && isLastName && isLastName) {
				return true;
			} else {
				// 驗證失敗，返回false
				return false;
			}
		};
	</script>

</body>

</html>