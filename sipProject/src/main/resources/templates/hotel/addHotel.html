<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="utf-8">
    <title>SIP.com 飯店後台-新增飯店</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">
    <style>
        .Error {
            display: none;
            font-size: 14px;
            font-weight: bold;
            color: rgb(249, 117, 117);
            margin: top 0px;
            margin-left: 160px;
        }

        .small-input {
            width: 300px;
            /* 自定義的寬度，可以根據需要調整 */
        }
    </style>
    <div th:replace="~{backStageNavbar/backStageNavbar_1}"></div>
</head>

<body>
    <div th:replace="~{backStageNavbar/backStageNavbar_2}"></div>
    <!-- Content Start -->
    <div class="content">
        <div th:replace="~{backStageNavbar/backStageNavbar_3}"></div>
        <form class="addHotel" id="addHotel">
            <div class="container-fluid pt-4 px-4">
                <div class="row g-4 h6">
                    <div class="col-sm-12 col-md-6">
                        <div class="bg-light rounded h-100 p-5">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <h6>飯店基本資料</h6>
                            </div>
                            <div class="mb-3">
                                <label for="hotelName" class="form-label">飯店</label>
                                <input type="text" class="form-control small-input text-dark" id="hotelName"
                                    name="hotelName" required>
                            </div>
                            <span class="Error" id="hotelNameError"></span> <!-- 顯示錯誤訊息 -->
                            <div class="mb-3">
                                <label for="hotelType" class="form-label">飯店類型</label>
                                <select class="form-select mb-3 small-input text-dark" name="hotelType"
                                    aria-label=".form-select-sm example" id="hotelType">
                                    <option value="民宿">民宿</option>
                                    <option value="星級飯店">星級飯店</option>
                                    <option value="渡假村">渡假村</option>
                                    <!-- 增加更多選項 -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="hotelStar" class="form-label">飯店星級</label>
                                <select class="form-select mb-3 small-input text-dark"
                                    aria-label=".form-select-sm example" id="hotelStar" name="hotelStar">
                                    <option value="民宿">民宿</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="guiNumber" class="form-label">統一編號</label>
                                <input type="number" class="form-control small-input text-dark" id="guiNumber"
                                    name="guiNumber" required>
                            </div>
                            <span class="Error" id="guiNumberError"></span> <!-- 顯示錯誤訊息 -->
                            <div class="mb-3">
                                <label for="businessName" class="form-label">營業負責人</label>
                                <input type="text" class="form-control small-input text-dark" id="businessName"
                                    name="businessName" required>
                            </div>
                            <span class="Error" id="businessNameError"></span> <!-- 顯示錯誤訊息 -->
                            <div class="mb-3">
                                <label for="openYear" class="form-label">開業年份</label>
                                <select class="form-select mb-3 small-input text-dark"
                                    aria-label=".form-select-sm example" id="openYear" name="openYear" required>
                                    <option value="">選擇年份</option>
                                    <option th:selected="true" id="defaultYear">
                                    </option>
                                </select>
                                <span class="Error" id="openYearError"></span> <!-- 顯示錯誤訊息 -->
                            </div>
                            <br>
                            <div class="mb-3 text-dark">
                                <h6>飯店設施服務</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="cleaningService">
                                    <label class="check-label" for="cleaningService">每日清潔服務
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="expressCheckin">
                                    <label class="check-label" for="expressCheckin">快速入住
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="counter24hr">
                                    <label class="check-label" for="counter24hr">24 小時接待櫃檯
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="freeWiFi">
                                    <label class="check-label" for="freeWiFi">
                                        免費WiFi
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="roomCard">
                                    <label class="check-label" for="roomCard">房卡進出
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="noSmoking">
                                    <label class="check-label" for="noSmoking">全面禁菸
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="petFriendly">
                                    <label class="check-label" for="petFriendly">可攜帶寵物
                                    </label>
                                </div>
                                <div class="addpetmoney" style="display: none;" id="addpetmoney">
                                    <div class="mb-3">
                                        <label for="petDeposit">攜帶寵物 房間押金</label>
                                        <input type="number" name="petDeposit"
                                            class="form-control small-input text-dark" id="petDeposit" />
                                        <span class="Error" id="petDepositError"></span> <!-- 顯示錯誤訊息 -->
                                    </div>
                                    <div class="mb-3">
                                        <label for="petCleaningFee">寵物清潔費</label>
                                        <input type="number" name="petCleaningFee"
                                            class="form-control small-input text-dark" id="petCleaningFee" />
                                        <span class="Error" id="petCleaningFeeError"></span> <!-- 顯示錯誤訊息 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <div class="bg-light rounded h-100 p-5">
                            <div class="mb-3">
                                <label for="tel" class="form-label">電話</label>
                                <input type="number" class="form-control small-input text-dark" id="tel" name="tel"
                                    required />
                                <span class="Error" id="telError"></span> <!-- 顯示錯誤訊息 -->
                            </div>
                            <div class="mb-3">
                                <label for="country" class="form-label">國家</label>
                                <input type="text" class="form-control small-input text-dark" id="country"
                                    name="country" value="台灣" readonly />
                            </div>
                            <div class="twzipcode mb-3">
                                <label for="city" class="form-label">城市</label>
                                <select data-role="county" name="city" class="form-select mb-3 small-input text-dark"
                                    id="city" aria-label="Default select example" required>
                                </select>
                                <span class="Error" id="cityError"></span> <!-- 顯示錯誤訊息 -->
                                <label for="region" class="form-label">鄉鎮</label>
                                <select data-role="district" name="region" id="region"
                                    class="form-select mb-3 small-input text-dark"
                                    aria-label="Default select example"></select>
                                <label for="postalCode" class="form-label small-input">郵遞區號</label>
                                <input type="text" readonly data-role="zipcode" name="postalCode" placeholder="郵遞區號"
                                    class="form-control small-input text-dark" id="postalCode" />
                            </div>
                            <div class="mb-3">
                                <label for="street">街區</label>
                                <input type="text" name="street" placeholder="街區" id="street"
                                    class="form-control small-input text-dark" required />
                                <span class="Error" id="streetError"></span> <!-- 顯示錯誤訊息 -->
                            </div>
                            <div class="mb-3">
                                <label for="street">飯店介紹</label>
                                <textarea class="form-control" name="hotelIntroduction" style="width: 694.5px; height: 150px; 
                                   " id="hotelIntroduction" required></textarea>
                                <span class="Error" id="hotelIntroductionError"></span> <!-- 顯示錯誤訊息 -->
                            </div>
                            <div class="mb-3">
                                <label for="street">預訂須知</label>
                                <textarea class="form-control" name="reservationNotice" style="width: 694.5px; height: 150px; 
                                   " id="reservationNotice"></textarea>
                            </div>
                            <button id="submitBtnUpdate" type="submit" class="btn btn-primary m-2">新增飯店</button>
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </div>
    <!-- Content End -->


    <!-- Footer --><!-- Back to Top -->
    <div th:replace="~{backStageNavbar/backStageNavbar_4}"></div>
    <!-- scriptNavbar -->
    <div th:replace="~{backStageNavbar/backStageNavbar_5}"></div>
    <script src="https://code.essoduke.org/js/twzipcode/twzipcode.latest.js"></script>
    <script th:src="@{/jquery-ui-1.13.2/jquery-ui.js}"></script>
    <script>
        var startYear = 1990;
        var endYear = new Date().getFullYear(); //拿到今年年份
        var yearSelect = document.getElementById("openYear");
        var defaultYear = document.getElementById("defaultYear").value;//拿到預設年
        // 清除初始選項
        yearSelect.innerHTML = "";
        // 創建第一個選項
        var initialOption = document.createElement("option");
        initialOption.value = "";
        initialOption.text = "選擇年份";
        yearSelect.appendChild(initialOption);
        // 創建下拉選單
        for (var year = startYear; year <= endYear; year++) {
            var option = document.createElement("option");
            option.value = year;
            option.text = year;
            yearSelect.appendChild(option);

            if (year === parseInt(defaultYear)) {
                //設定預設年在下拉選單
                option.selected = true;
            }
        }
        const twzipcode = new TWzipcode();
        var hotelNameInput = document.getElementById('hotelName');
        var hotelNameError = document.getElementById('hotelNameError');
        var streetInput = document.getElementById('street');
        var streetError = document.getElementById('streetError');
        var businessNameInput = document.getElementById('businessName');
        var businessNameError = document.getElementById('businessNameError');
        var hotelIntroductionInput = document.getElementById('hotelIntroduction');
        var hotelIntroductionError = document.getElementById('hotelIntroductionError');
        // 添加飯店名子输入事件
        hotelNameInput.addEventListener('input', validateHotelName);
        // 添加地址输入事件
        streetInput.addEventListener('input', validateStreet);
        // // 添加businessName输入事件
        businessNameInput.addEventListener('input', validateBusinessName);
        // 正規表示式 中英文
        var Regex = /^[a-zA-Z0-9\s\u4e00-\u9fa5#.,-]+$/;
        // 定義敏感詞彙
        var sensitiveWords = ["fuck", "Fuck"];
        //驗證內容_檢查內容中是否包含敏感詞彙
        function validateContent(text) {
            if (text.trim() === '') {
                return "required"; //限制 用required控制
            }
            if (!Regex.test(text)) {
                return "invalid"; //是否包含敏感詞彙
            }
            for (var i = 0; i < sensitiveWords.length; i++) {
                if (text.toLowerCase().includes(sensitiveWords[i].toLowerCase())) {
                    return "sensitive"; //是否包含敏感詞彙
                }
            }
            return "valid"; // all checks
        }
        function validateHotelName() {
            var hotelName = hotelNameInput.value;
            var validationResult = validateContent(hotelName);
            console.log('啟動');
            if (validationResult === "required") {
                hotelNameError.style.display = 'none';
                hotelNameError.textContent = '';
                return false;
            } else if (validationResult === "invalid") {
                hotelNameError.style.display = 'block';
                hotelNameError.textContent = '含敏感詞彙';
                return false;
            } else if (validationResult === "sensitive") {
                hotelNameError.style.display = 'block';
                hotelNameError.textContent = '含敏感詞彙';
                return false;
            }
            hotelNameError.style.display = 'none';
            hotelNameError.textContent = '';
            return true; // If everything is okay
        }

        function validateStreet() {
            console.log('啟動');
            var street = streetInput.value;
            var validationResult = validateContent(street);
            if (validationResult === "required") {
                streetError.style.display = 'none';
                streetError.textContent = '';
                return false;
            } else if (validationResult === "invalid") {
                streetError.style.display = 'block';
                streetError.textContent = '含敏感詞彙';
                return false;
            } else if (validationResult === "sensitive") {
                streetError.style.display = 'block';
                streetError.textContent = '含敏感詞彙';
                return false;
            }
            streetError.style.display = 'none';
            streetError.textContent = '';
            return true; // If everything is okay
        }

        function validateBusinessName() {
            console.log('啟動');
            var businessName = businessNameInput.value;
            var validationResult = validateContent(businessName);
            if (validationResult === "required") {
                businessNameError.style.display = 'none';
                businessNameError.textContent = '';
                return false;
            } else if (validationResult === "invalid") {
                businessNameError.style.display = 'block';
                businessNameError.textContent = '含敏感詞彙';
                return false;
            } else if (validationResult === "sensitive") {
                businessNameError.style.display = 'block';
                businessNameError.textContent = '含敏感詞彙';
                return false;
            }
            businessNameError.style.display = 'none';
            businessNameError.textContent = '';
            return true; // If everything is okay
        }

        var petDepositInput = document.getElementById('petDeposit');
        var petDepositError = document.getElementById('petDepositError');
        var petCleaningFeeInput = document.getElementById('petCleaningFee');
        var petCleaningFeeError = document.getElementById('petCleaningFeeError');
        var addpetmoneyInput = document.getElementById('addpetmoney');
        var petFriendlyInput = document.getElementById('petFriendly');
        var petFriendly = petFriendlyInput.checked;
        if (petFriendly === true) {
            addpetmoneyInput.style.display = 'block';
        }
        petFriendlyInput.addEventListener('change', function () {
            if (petFriendlyInput.checked) {
                addpetmoneyInput.style.display = 'block';
                petDepositInput.setAttribute('required', 'required');
                petCleaningFeeInput.setAttribute('required', 'required');
            } else {
                addpetmoneyInput.style.display = 'none';
                petDepositInput.removeAttribute('required');
                petCleaningFeeInput.removeAttribute('required');
            }
        });
        petDepositInput.addEventListener('input', validatepetDeposit)
        petCleaningFeeInput.addEventListener('input', validatepetCleaningFee)

        function validatepetDeposit() {
            var inputValue = petDepositInput.value;
            if (parseInt(inputValue) > 50000) {
                petDepositError.style.display = 'block';
                petDepositError.textContent = '請輸入金額。金額上限50000';
                return false;
            } else {
                petDepositError.style.display = 'none';
                petDepositError.textContent = '';
                return true;
            }

        }
        function validatepetCleaningFee() {
            var inputValue = petCleaningFeeInput.value;
            if (parseInt(inputValue) > 50000) {
                petCleaningFeeError.style.display = 'block';
                petCleaningFeeError.textContent = '請輸入金額。金額上限50000';
                return false;
            } else {
                petCleaningFeeError.style.display = 'none';
                petCleaningFeeError.textContent = '';
                return true;
            }

        }

        // 驗證數據 送出數據
        function validateAndSubmit() {
            var isHotelName = validateHotelName();
            var isStreet = validateStreet();
            var isBusinessName = validateBusinessName();

            if (isHotelName && isStreet && isBusinessName) {
                return true;
            } else {
                // 驗證失敗，返回false
                return false;
            }
        };

        $(document).ready(function () {

            $('#submitBtnUpdate').click(function (event) {
                //取消預設動作
                event.preventDefault();
                var form = document.getElementById('addHotel');
                // 開啟required功能
                if (form.checkValidity()) {
                    // 收集表單數據並組成兩個 JSON 物件
                    const hotel = {
                        hotelName: $("#hotelName").val(),
                        hotelType: $("#hotelType").val(),
                        hotelStar: $("#hotelStar").val(),
                        tel: $("#tel").val(),
                        country: $("#country").val(),
                        city: $("#city").val(),
                        region: $("#region").val(),
                        street: $("#street").val(),
                        postalCode: $("#postalCode").val(),
                        hotelIntroduction: $("#hotelIntroduction").val(),
                    };
                    const hotelDetail = {
                        guiNumber: $("#guiNumber").val(),
                        businessName: $("#businessName").val(),
                        openYear: $("#openYear").val(),
                        cleaningService: $("#cleaningService").is(":checked"),
                        expressCheckin: $("#expressCheckin").is(":checked"),
                        counter24hr: $("#counter24hr").is(":checked"),
                        freeWiFi: $("#freeWiFi").is(":checked"),
                        roomCard: $("#roomCard").is(":checked"),
                        noSmoking: $("#noSmoking").is(":checked"),
                        petFriendly: $("#petFriendly").is(":checked"),
                        petDeposit: $("#petDeposit").val(),
                        petCleaningFee: $("#petCleaningFee").val(),
                        reservationNotice: $("#reservationNotice").val(),
                    };
                    // 將兩個物件包裝成一個大的 JSON 物件
                    const requestData = {
                        hotel: hotel,
                        hotelDetail: hotelDetail,
                    };
                    // 驗證數據
                    if (!validateAndSubmit()) {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "有一些錯誤",
                        });
                        return false; // 數據驗證失敗按鈕無法下一步
                    }
                    Swal.fire({
                        icon: 'question',
                        title: '新增飯店',
                        showCancelButton: true,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                type: 'POST',
                                url: '/sip/hotel/addHotel',
                                contentType: 'application/json',  // 設定請求的內容類型為 JSON
                                data: JSON.stringify(requestData),  // 將 JavaScript 對象轉換為 JSON 字符串
                                headers: {
                                    'X-CSRF-TOKEN': $('input[name=_csrf]').val()
                                },
                                //成功重新導向
                                success: function (response) {
                                    console.log('checkState success:', response);
                                    if (response === "Y") {
                                        window.location.href = "/sip/hotel/chooseHotel";
                                    }
                                },
                                error: function (error) {
                                    console.error('AJAX error:', error);
                                }
                            });
                        }
                    })
                } else {
                    form.reportValidity();
                }

            });
        })
    </script>
</body>

</html>